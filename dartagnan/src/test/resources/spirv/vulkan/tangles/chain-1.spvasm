; @Input: %_ = {{0}}
; @Input: %__0 = {{0, 0, 0}}
; @Input: %__1 = {{0, 0, 0}}
; @Input: %__2 = {{0, 0, 0}}
; @Output: exists (%__0[0][0] == 1 and %__2[0][1] == 0)
; @Config: 3, 1, 1
; SPIR-V
; Version: 1.6
; Generator: Khronos Glslang Reference Front End; 10
; Bound: 123
; Schema: 0
               OpCapability Shader
               OpCapability GroupNonUniform
               OpCapability GroupNonUniformVote
               OpCapability VulkanMemoryModel
               OpExtension "SPV_KHR_vulkan_memory_model"
          %2 = OpExtInstImport "GLSL.std.450"
               OpMemoryModel Logical Vulkan
               OpEntryPoint GLCompute %main "main" %gl_SubgroupID %gl_SubgroupSize %gl_SubgroupInvocationID %gl_NumWorkGroups %gl_WorkGroupID %_ %__0 %__1 %__2
               OpExecutionModeId %main LocalSizeId %uint_1 %uint_1 %uint_1
          %1 = OpString "benchmarks/glsl/tangles/chain-1.comp"
               OpSource GLSL 460 %1 "//; @Input: %_ = {{0}}
//; @Input: %__0 = {{0, 0, 0}}
//; @Input: %__1 = {{0, 0, 0}}
//; @Input: %__2 = {{0, 0, 0}}
//; @Output: exists (%__0[0][0] == 1 and %__2[0][1] == 0)
//; @Config: 3, 1, 1

#version 460
#extension GL_KHR_shader_subgroup_basic : enable
#extension GL_KHR_shader_subgroup_vote : enable
#extension GL_KHR_memory_scope_semantics : enable

#define scope_subgroup 3
#define storage_sem_buffer 64
#define storage_sem_wg 256 // Might even need SubgroupMemory (128) for subgroup barriers/operations
#define sem_release 4
#define sem_acquire 2

layout(set = 0, binding = 0) buffer X { uint x[]; };
layout(set = 0, binding = 1) buffer Buf0 { uint buf0[]; };
layout(set = 0, binding = 2) buffer Buf1 { uint buf1[]; };
layout(set = 0, binding = 3) buffer Buf2 { uint buf2[]; };

void main() {
    uint subgroup_id = gl_SubgroupID;
    uint subgroup_size = gl_SubgroupSize;
    uint subgroup_local_id = gl_SubgroupInvocationID;
    uint num_workgroup = gl_NumWorkGroups.x;
    uint workgroup_size = gl_WorkGroupSize.x;
    uint workgroup_id = gl_WorkGroupID.x;
    uint workgroup_base = workgroup_size * workgroup_id;
    uint subgroup_base = subgroup_id * subgroup_size;
    uint virtual_gid = workgroup_base + subgroup_base + subgroup_local_id;
    uint next_virtual_gid = workgroup_base + subgroup_base + ((subgroup_local_id + 1) % subgroup_size);

    uint r0 = 0;
    bool r1 = false;
    uint r2 = 0;

    if(virtual_gid == 0) {
        r0 = atomicLoad(x[0], scope_subgroup, storage_sem_wg, sem_acquire);
    }
    if(virtual_gid == 0 || virtual_gid == 1) {
        r1 = subgroupAny(false);
    }
    if(virtual_gid == 1) {
        r2 = atomicLoad(x[0], scope_subgroup, storage_sem_wg, sem_acquire); // Nothing prevents this to be moved before the subgroupAny
    }
    if(virtual_gid == 2) {
        atomicStore(x[0], uint(1), scope_subgroup, storage_sem_wg, sem_release);
    }

    atomicStore(buf0[virtual_gid], uint(r0), scope_subgroup, storage_sem_wg, sem_release);
    atomicStore(buf1[virtual_gid], uint(r1), scope_subgroup, storage_sem_wg, sem_release);
    atomicStore(buf2[virtual_gid], uint(r2), scope_subgroup, storage_sem_wg, sem_release);
}"
               OpSourceExtension "GL_KHR_memory_scope_semantics"
               OpSourceExtension "GL_KHR_shader_subgroup_basic"
               OpSourceExtension "GL_KHR_shader_subgroup_vote"
               OpName %main "main"
               OpName %subgroup_id "subgroup_id"
               OpName %gl_SubgroupID "gl_SubgroupID"
               OpName %subgroup_size "subgroup_size"
               OpName %gl_SubgroupSize "gl_SubgroupSize"
               OpName %subgroup_local_id "subgroup_local_id"
               OpName %gl_SubgroupInvocationID "gl_SubgroupInvocationID"
               OpName %num_workgroup "num_workgroup"
               OpName %gl_NumWorkGroups "gl_NumWorkGroups"
               OpName %workgroup_size "workgroup_size"
               OpName %workgroup_id "workgroup_id"
               OpName %gl_WorkGroupID "gl_WorkGroupID"
               OpName %workgroup_base "workgroup_base"
               OpName %subgroup_base "subgroup_base"
               OpName %virtual_gid "virtual_gid"
               OpName %next_virtual_gid "next_virtual_gid"
               OpName %r0 "r0"
               OpName %r1 "r1"
               OpName %r2 "r2"
               OpName %X "X"
               OpMemberName %X 0 "x"
               OpName %_ ""
               OpName %Buf0 "Buf0"
               OpMemberName %Buf0 0 "buf0"
               OpName %__0 ""
               OpName %Buf1 "Buf1"
               OpMemberName %Buf1 0 "buf1"
               OpName %__1 ""
               OpName %Buf2 "Buf2"
               OpMemberName %Buf2 0 "buf2"
               OpName %__2 ""
               OpModuleProcessed "client vulkan100"
               OpModuleProcessed "target-env spirv1.6"
               OpModuleProcessed "target-env vulkan1.3"
               OpModuleProcessed "entry-point main"
               OpDecorate %gl_SubgroupID BuiltIn SubgroupId
               OpDecorate %gl_SubgroupSize RelaxedPrecision
               OpDecorate %gl_SubgroupSize BuiltIn SubgroupSize
               OpDecorate %16 RelaxedPrecision
               OpDecorate %gl_SubgroupInvocationID RelaxedPrecision
               OpDecorate %gl_SubgroupInvocationID BuiltIn SubgroupLocalInvocationId
               OpDecorate %19 RelaxedPrecision
               OpDecorate %gl_NumWorkGroups BuiltIn NumWorkgroups
               OpDecorate %gl_WorkGroupID BuiltIn WorkgroupId
               OpDecorate %_runtimearr_uint ArrayStride 4
               OpMemberDecorate %X 0 Offset 0
               OpDecorate %X Block
               OpDecorate %_ DescriptorSet 0
               OpDecorate %_ Binding 0
               OpDecorate %_runtimearr_uint_0 ArrayStride 4
               OpMemberDecorate %Buf0 0 Offset 0
               OpDecorate %Buf0 Block
               OpDecorate %__0 DescriptorSet 0
               OpDecorate %__0 Binding 1
               OpDecorate %_runtimearr_uint_1 ArrayStride 4
               OpMemberDecorate %Buf1 0 Offset 0
               OpDecorate %Buf1 Block
               OpDecorate %__1 DescriptorSet 0
               OpDecorate %__1 Binding 2
               OpDecorate %_runtimearr_uint_2 ArrayStride 4
               OpMemberDecorate %Buf2 0 Offset 0
               OpDecorate %Buf2 Block
               OpDecorate %__2 DescriptorSet 0
               OpDecorate %__2 Binding 3
       %void = OpTypeVoid
          %4 = OpTypeFunction %void
       %uint = OpTypeInt 32 0
     %uint_1 = OpConstant %uint 1
%_ptr_Function_uint = OpTypePointer Function %uint
%_ptr_Input_uint = OpTypePointer Input %uint
%gl_SubgroupID = OpVariable %_ptr_Input_uint Input
%gl_SubgroupSize = OpVariable %_ptr_Input_uint Input
%gl_SubgroupInvocationID = OpVariable %_ptr_Input_uint Input
     %v3uint = OpTypeVector %uint 3
%_ptr_Input_v3uint = OpTypePointer Input %v3uint
%gl_NumWorkGroups = OpVariable %_ptr_Input_v3uint Input
     %uint_0 = OpConstant %uint 0
%gl_WorkGroupID = OpVariable %_ptr_Input_v3uint Input
       %bool = OpTypeBool
%_ptr_Function_bool = OpTypePointer Function %bool
      %false = OpConstantFalse %bool
%_runtimearr_uint = OpTypeRuntimeArray %uint
          %X = OpTypeStruct %_runtimearr_uint
%_ptr_StorageBuffer_X = OpTypePointer StorageBuffer %X
          %_ = OpVariable %_ptr_StorageBuffer_X StorageBuffer
        %int = OpTypeInt 32 1
      %int_0 = OpConstant %int 0
%_ptr_StorageBuffer_uint = OpTypePointer StorageBuffer %uint
      %int_3 = OpConstant %int 3
    %int_256 = OpConstant %int 256
      %int_2 = OpConstant %int 2
   %uint_258 = OpConstant %uint 258
     %uint_3 = OpConstant %uint 3
     %uint_2 = OpConstant %uint 2
      %int_4 = OpConstant %int 4
   %uint_260 = OpConstant %uint 260
%_runtimearr_uint_0 = OpTypeRuntimeArray %uint
       %Buf0 = OpTypeStruct %_runtimearr_uint_0
%_ptr_StorageBuffer_Buf0 = OpTypePointer StorageBuffer %Buf0
        %__0 = OpVariable %_ptr_StorageBuffer_Buf0 StorageBuffer
%_runtimearr_uint_1 = OpTypeRuntimeArray %uint
       %Buf1 = OpTypeStruct %_runtimearr_uint_1
%_ptr_StorageBuffer_Buf1 = OpTypePointer StorageBuffer %Buf1
        %__1 = OpVariable %_ptr_StorageBuffer_Buf1 StorageBuffer
%_runtimearr_uint_2 = OpTypeRuntimeArray %uint
       %Buf2 = OpTypeStruct %_runtimearr_uint_2
%_ptr_StorageBuffer_Buf2 = OpTypePointer StorageBuffer %Buf2
        %__2 = OpVariable %_ptr_StorageBuffer_Buf2 StorageBuffer
       %main = OpFunction %void None %4
          %6 = OpLabel
%subgroup_id = OpVariable %_ptr_Function_uint Function
%subgroup_size = OpVariable %_ptr_Function_uint Function
%subgroup_local_id = OpVariable %_ptr_Function_uint Function
%num_workgroup = OpVariable %_ptr_Function_uint Function
%workgroup_size = OpVariable %_ptr_Function_uint Function
%workgroup_id = OpVariable %_ptr_Function_uint Function
%workgroup_base = OpVariable %_ptr_Function_uint Function
%subgroup_base = OpVariable %_ptr_Function_uint Function
%virtual_gid = OpVariable %_ptr_Function_uint Function
%next_virtual_gid = OpVariable %_ptr_Function_uint Function
         %r0 = OpVariable %_ptr_Function_uint Function
         %r1 = OpVariable %_ptr_Function_bool Function
         %r2 = OpVariable %_ptr_Function_uint Function
               OpLine %1 25 0
         %13 = OpLoad %uint %gl_SubgroupID
               OpStore %subgroup_id %13
               OpLine %1 26 0
         %16 = OpLoad %uint %gl_SubgroupSize
               OpStore %subgroup_size %16
               OpLine %1 27 0
         %19 = OpLoad %uint %gl_SubgroupInvocationID
               OpStore %subgroup_local_id %19
               OpLine %1 28 0
         %25 = OpAccessChain %_ptr_Input_uint %gl_NumWorkGroups %uint_0
         %26 = OpLoad %uint %25
               OpStore %num_workgroup %26
               OpLine %1 29 0
               OpStore %workgroup_size %uint_1
               OpLine %1 30 0
         %30 = OpAccessChain %_ptr_Input_uint %gl_WorkGroupID %uint_0
         %31 = OpLoad %uint %30
               OpStore %workgroup_id %31
               OpLine %1 31 0
         %33 = OpLoad %uint %workgroup_size
         %34 = OpLoad %uint %workgroup_id
         %35 = OpIMul %uint %33 %34
               OpStore %workgroup_base %35
               OpLine %1 32 0
         %37 = OpLoad %uint %subgroup_id
         %38 = OpLoad %uint %subgroup_size
         %39 = OpIMul %uint %37 %38
               OpStore %subgroup_base %39
               OpLine %1 33 0
         %41 = OpLoad %uint %workgroup_base
         %42 = OpLoad %uint %subgroup_base
         %43 = OpIAdd %uint %41 %42
         %44 = OpLoad %uint %subgroup_local_id
         %45 = OpIAdd %uint %43 %44
               OpStore %virtual_gid %45
               OpLine %1 34 0
         %47 = OpLoad %uint %workgroup_base
         %48 = OpLoad %uint %subgroup_base
         %49 = OpIAdd %uint %47 %48
         %50 = OpLoad %uint %subgroup_local_id
         %51 = OpIAdd %uint %50 %uint_1
         %52 = OpLoad %uint %subgroup_size
         %53 = OpUMod %uint %51 %52
         %54 = OpIAdd %uint %49 %53
               OpStore %next_virtual_gid %54
               OpLine %1 36 0
               OpStore %r0 %uint_0
               OpLine %1 37 0
               OpStore %r1 %false
               OpLine %1 38 0
               OpStore %r2 %uint_0
               OpLine %1 40 0
         %61 = OpLoad %uint %virtual_gid
         %62 = OpIEqual %bool %61 %uint_0
               OpSelectionMerge %64 None
               OpBranchConditional %62 %63 %64
         %63 = OpLabel
               OpLine %1 41 0
         %72 = OpAccessChain %_ptr_StorageBuffer_uint %_ %int_0 %int_0
         %77 = OpAtomicLoad %uint %72 %int_3 %uint_258
               OpStore %r0 %77
               OpBranch %64
         %64 = OpLabel
               OpLine %1 43 0
         %78 = OpLoad %uint %virtual_gid
         %79 = OpIEqual %bool %78 %uint_0
         %80 = OpLoad %uint %virtual_gid
         %81 = OpIEqual %bool %80 %uint_1
         %82 = OpLogicalOr %bool %79 %81
               OpSelectionMerge %84 None
               OpBranchConditional %82 %83 %84
         %83 = OpLabel
               OpLine %1 44 0
         %86 = OpGroupNonUniformAny %bool %uint_3 %false
               OpStore %r1 %86
               OpBranch %84
         %84 = OpLabel
               OpLine %1 46 0
         %87 = OpLoad %uint %virtual_gid
         %88 = OpIEqual %bool %87 %uint_1
               OpSelectionMerge %90 None
               OpBranchConditional %88 %89 %90
         %89 = OpLabel
               OpLine %1 47 0
         %91 = OpAccessChain %_ptr_StorageBuffer_uint %_ %int_0 %int_0
         %92 = OpAtomicLoad %uint %91 %int_3 %uint_258
               OpStore %r2 %92
               OpBranch %90
         %90 = OpLabel
               OpLine %1 49 0
         %93 = OpLoad %uint %virtual_gid
         %95 = OpIEqual %bool %93 %uint_2
               OpSelectionMerge %97 None
               OpBranchConditional %95 %96 %97
         %96 = OpLabel
               OpLine %1 50 0
         %98 = OpAccessChain %_ptr_StorageBuffer_uint %_ %int_0 %int_0
               OpAtomicStore %98 %int_3 %uint_260 %uint_1
               OpBranch %97
         %97 = OpLabel
               OpLine %1 53 0
        %105 = OpLoad %uint %virtual_gid
        %106 = OpAccessChain %_ptr_StorageBuffer_uint %__0 %int_0 %105
        %107 = OpLoad %uint %r0
               OpAtomicStore %106 %int_3 %uint_260 %107
               OpLine %1 54 0
        %112 = OpLoad %uint %virtual_gid
        %113 = OpAccessChain %_ptr_StorageBuffer_uint %__1 %int_0 %112
        %114 = OpLoad %bool %r1
        %115 = OpSelect %uint %114 %uint_1 %uint_0
               OpAtomicStore %113 %int_3 %uint_260 %115
               OpLine %1 55 0
        %120 = OpLoad %uint %virtual_gid
        %121 = OpAccessChain %_ptr_StorageBuffer_uint %__2 %int_0 %120
        %122 = OpLoad %uint %r2
               OpAtomicStore %121 %int_3 %uint_260 %122
               OpReturn
               OpFunctionEnd
